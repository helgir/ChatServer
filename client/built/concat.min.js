angular.module("ChatApp").controller("HomeCtrl", ["$scope", "$http", "$location", "socket", "$rootScope", function(a, b, c, d, e) {
    a.nickId = "", a.loggedIn = !1, a.errorMessage = "", a.login_error = !1, a.login = function() {
        return "" === a.nickId ? (a.loggedIn = !1, a.login_error = !0, void(a.errorMessage = "Please enter nickname")) : void d.emit("adduser", a.nickId, function(b) {
            b ? (a.loggedIn = !0, c.path("/rooms/" + a.nickId)) : (a.loggedIn = !1, a.login_error = !0, a.errorMessage = "This nickname is unavailable")
        })
    }
}]), angular.module("ChatApp").controller("RoomCtrl", ["$scope", "$http", "$routeParams", "$location", "socket", "$rootScope", function(a, b, c, d, e, f) {
    function g() {
        "true" == c.locked ? (alertify.set({
            labels: {
                ok: "Join",
                cancel: "Cancel"
            }
        }), alertify.prompt("Password: ", function(b, c) {
            h(a.roomId, c)
        })) : h(a.roomId, void 0)
    }

    function h(b, c) {
        e.emit("joinroom", {
            room: b,
            pass: c
        }, function(b, c) {
            b || ("banned" === c ? (d.path("/rooms/" + a.nickId), alertify.alert("You are banned from this room")) : "wrong password" === c && (d.path("/rooms/" + a.nickId), alertify.alert("Wrong password!")))
        })
    }

    function i(a) {
        var b, c = a.getUTCHours() > 9 ? a.getUTCHours() : "0" + a.getUTCHours(),
            d = a.getUTCMinutes() > 9 ? a.getUTCMinutes() : "0" + a.getUTCMinutes(),
            e = a.getUTCSeconds() > 9 ? a.getUTCSeconds() : "0" + a.getUTCSeconds();
        return b = c + ":" + d + ":" + e
    }

    function j() {
        moment.locale("is");
        var a = moment().format("LTS");
        return a
    }
    a.roomId = c.roomId, a.nickId = c.nickId, a.nicks = [], a.submitMessage = "", a.messages = [], a.topic = "", a.userSelected = !1, a.nickSelected = "", a.pmMessages = {}, a.pmUnreadFrom = [], a.pmSubmitMessage = "", a.isop = !1, a.nickSelect = "", a.topicToChange = "", a.pwToChange = "", a.glued = !0, g(), e.on("updateusers", function(b, c, d) {
        if (a.roomId === b) {
            a.isop = void 0 !== d[a.nickId], a.nicks = c;
            for (var e in a.nicks) a.pmUnreadFrom[e] = !1
        }
    }), a.sendMSG = function() {
        "" === a.submitMessage || e.emit("sendmsg", {
            roomName: a.roomId,
            msg: a.submitMessage
        }), a.submitMessage = ""
    }, a.sendPmMSG = function() {
        "" === a.pmSubmitMessage || (console.log(a.pmSubmitMessage), e.emit("privatemsg", {
            nick: a.nickSelected,
            message: a.pmSubmitMessage
        }, function(b) {
            b ? (void 0 === a.pmMessages[a.nickSelected] && (a.pmMessages[a.nickSelected] = []), a.pmMessages[a.nickSelected].push({
                sender: a.nickId,
                message: a.pmSubmitMessage,
                timestamp: j()
            }), a.pmSubmitMessage = "") : (void 0 === a.pmMessages[a.nickSelected] && (a.pmMessages[a.nickSelected] = []), a.pmMessages[a.nickSelected].push({
                sender: "server",
                message: "Failed to send message"
            }))
        }))
    }, e.on("recv_privatemsg", function(b, c) {
        void 0 === a.pmMessages[b] && (a.pmMessages[b] = []), a.pmMessages[b].push({
            sender: b,
            message: c,
            timestamp: j()
        }), a.nickSelected !== b && (a.pmUnreadFrom[b] = !0), a.userSelected === !1 && a.showPmBox(b)
    }), a.partRoom = function() {
        var b = "has left the room";
        e.emit("sendmsg", {
            roomName: a.roomId,
            msg: b
        }), e.emit("partroom", a.roomId), d.path("/rooms/" + a.nickId)
    }, e.on("updatechat", function(b, c) {
        if (b === a.roomId) {
            a.messages = [];
            for (var d = 0; d < c.length; d++) {
                var e = new Date(c[d].timestamp);
                a.messages.push({
                    nick: c[d].nick,
                    message: c[d].message,
                    timestamp: i(e)
                }), console.log(JSON.stringify(a.messages[d]))
            }
        }
    }), e.on("updatetopic", function(b, c) {
        b === a.roomId && (a.topic = c)
    }), a.showPmBox = function(b) {
        a.nickId !== b && (a.nickSelected != b ? (a.nickSelected = b, a.userSelected = !0, a.pmUnreadFrom[b] = !1) : (a.userSelected = !1, a.nickSelected = "", a.pmUnreadFrom[b] = !1))
    }, a.selectOrders = function(b, c) {
        if ("kick" === b) {
            var d = "has kicked " + c;
            e.emit("sendmsg", {
                roomName: a.roomId,
                msg: d
            })
        }
        e.emit(b, {
            room: a.roomId,
            user: c
        }, function(a) {})
    }, e.on("kicked", function(b, c, e) {
        a.roomId === b && a.nickId === c && (d.path("/rooms/" + a.nickId), a.roomId = "", alertify.error("You have been kicked from " + b)), a.nickId === e
    }), e.on("banned", function(b, c, f) {
        if (a.roomId === b && a.nickId === c && (d.path("/rooms/" + a.nickId), alertify.error("You have been banned from " + b, 0)), a.nickId === f) {
            var g = "has banned " + c;
            e.emit("sendmsg", {
                roomName: a.roomId,
                msg: g
            })
        }
    }), e.on("opped", function(b, c, d) {
        if (a.roomId === b && a.nickId === c && alertify.success("You are now op"), a.nickId === d) {
            var f = "has opped " + c;
            e.emit("sendmsg", {
                roomName: a.roomId,
                msg: f
            })
        }
    }), e.on("deopped", function(b, c, d) {
        if (a.roomId === b && a.nickId === c && alertify.error("You have been deopped"), a.nickId === d) {
            var f = "has deopped " + c;
            e.emit("sendmsg", {
                roomName: a.roomId,
                msg: f
            })
        }
    }), a.changeTopic = function() {
        "" === a.topicToChange || (e.emit("settopic", {
            room: a.roomId,
            topic: a.topicToChange
        }), a.topicToChange = "")
    }, a.changePassword = function() {
        "" === a.pwToChange || (e.emit("setpassword", {
            room: a.roomId,
            password: a.pwToChange
        }), alertify.success("Password changed to: " + a.pwToChange), a.pwToChange = "")
    }, a.removePassword = function() {
        e.emit("removepassword", {
            room: a.roomId
        }, function(a) {
            a && alertify.success("Password removed")
        })
    }, a.orders = [{
        value: "op",
        label: "Give Op"
    }, {
        value: "deop",
        label: "De Op"
    }, {
        value: "kick",
        label: "Kick"
    }, {
        value: "ban",
        label: "Ban"
    }]
}]), angular.module("ChatApp").controller("RoomsCtrl", ["$scope", "$http", "$routeParams", "$location", "socket", "$rootScope", function(a, b, c, d, e, f) {
    a.nickId = c.nickId, a.roomId = "", a.rooms = [], a.errorMessage = "", a.create_error = !1, a.newRoom = function() {
        "" === a.roomId ? (a.errorMessage = "Please enter room name", a.create_error = !0) : void 0 !== a.rooms[a.roomId] ? (a.errorMessage = "The room name " + a.roomId + " is already taken", a.create_error = !0) : e.emit("createroom", {
            room: a.roomId
        }, function(b, c) {
            b && d.path("/rooms/" + a.nickId + "/" + a.roomId).search({
                locked: !1
            })
        })
    }, e.on("roomlist", function(b) {
        a.rooms = b, a.roomlist = [], $.each(a.rooms, function(b, c) {
            a.roomlist.push({
                name: b,
                locked: c.locked,
                size: Object.keys(c.users).length
            })
        })
    }), e.emit("rooms")
}]), angular.module("ChatApp", ["ng", "ngRoute", "luegg.directives"]), angular.module("ChatApp").config(function(a) {
    a.when("/home/login", {
        templateUrl: "/views/home.html",
        controller: "HomeCtrl"
    }).when("/rooms/:nickId", {
        templateUrl: "/views/rooms.html",
        controller: "RoomsCtrl"
    }).when("/rooms/:nickId/:roomId", {
        templateUrl: "/views/room.html",
        controller: "RoomCtrl"
    }).otherwise({
        redirectTo: "home/login"
    })
}), angular.module("ChatApp").factory("socket", ["$rootScope", function(a) {
    var b = io.connect("http://localhost:8080");
    return {
        on: function(c, d) {
            b.on(c, function() {
                var c = arguments;
                a.$apply(function() {
                    d.apply(b, c)
                })
            })
        },
        emit: function(c, d, e) {
            b.emit(c, d, function() {
                var c = arguments;
                a.$apply(function() {
                    e && e.apply(b, c)
                })
            })
        },
        getSocket: function() {
            return b
        }
    }
}]);
