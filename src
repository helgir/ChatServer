angular.module("ChatApp").controller("HomeCtrl",["$scope","$http","$location","socket","$rootScope",function(a,b,c,d,e){a.nickId="",a.loggedIn=!1,a.errorMessage="",a.login_error=!1,a.$on("$destroy",function(a){d.getSocket().removeAllListeners()}),a.login=function(){return""===a.nickId?(a.loggedIn=!1,a.login_error=!0,void(a.errorMessage="Please enter nickname")):void d.emit("adduser",a.nickId,function(b){b?(a.loggedIn=!0,c.path("/rooms/"+a.nickId)):(a.loggedIn=!1,a.login_error=!0,a.errorMessage="This nickname is unavailable")})}}]),angular.module("ChatApp").controller("RoomCtrl",["$scope","$http","$routeParams","$location","socket","$rootScope",function(a,b,c,d,e,f){function g(){"true"==c.locked?(alertify.set({labels:{ok:"Join",cancel:"Cancel"}}),alertify.prompt("Password: ",function(b,c){b===!0?h(a.roomId,c):f.$apply(function(){d.path("/rooms/"+a.nickId)})}),alertify.set({labels:{ok:"Ok",cancel:"Cancel"}})):h(a.roomId,void 0)}function h(b,c){e.emit("joinroom",{room:b,pass:c},function(b,c){b||("banned"===c?(d.path("/rooms/"+a.nickId),alertify.alert("You are banned from this room")):"wrong password"===c&&(d.path("/rooms/"+a.nickId),alertify.alert("Wrong password!")))})}function i(a){var b,c=a.getUTCHours()>9?a.getUTCHours():"0"+a.getUTCHours(),d=a.getUTCMinutes()>9?a.getUTCMinutes():"0"+a.getUTCMinutes(),e=a.getUTCSeconds()>9?a.getUTCSeconds():"0"+a.getUTCSeconds();return b=c+":"+d+":"+e}function j(){moment.locale("is");var a=moment().format("LTS");return a}a.roomId=c.roomId,a.nickId=c.nickId,a.nicks=[],a.submitMessage="",a.messages=[],a.topic="",a.userSelected=!1,a.nickSelected="",a.pmMessages={},a.pmUnreadFrom=[],a.pmSubmitMessage="",a.isop=!1,a.nickSelect="",a.topicToChange="",a.pwToChange="",a.glued=!0,g(),a.$on("$destroy",function(a){e.getSocket().removeAllListeners()}),e.on("updateusers",function(b,c,d){if(a.roomId===b){a.isop=void 0!==d[a.nickId],a.nicks=c;for(var e in a.nicks)a.pmUnreadFrom[e]=!1}}),e.on("servermessage",function(b,c,d,e){switch(b){case"join":a.roomId===c&&alertify.success(d+" has joined the room");break;case"part":a.roomId===c&&alertify.success(d+" has left the room");break;case"quit":void 0!==c[a.roomId]&&alertify.success(d+" has left the room");break;case"op":a.roomId===c&&e!==a.nickId&&alertify.success(d+" opped "+e);break;case"deop":a.roomId===c&&e!==a.nickId&&alertify.success(d+" deopped "+e);break;case"kick":a.roomId===c&&e!==a.nickId&&alertify.success(d+" kicked "+e);break;case"ban":a.roomId===c&&e!==a.nickId&&alertify.success(d+" banned "+e);break;case"unban":a.roomId===c?alertify.success(d+" unbanned "+e):e===a.nickId&&alertify.success("You have been unbanned from "+c+" by "+d)}}),a.sendMSG=function(){""===a.submitMessage||e.emit("sendmsg",{roomName:a.roomId,msg:a.submitMessage}),a.submitMessage=""},a.sendPmMSG=function(){""===a.pmSubmitMessage||(console.log(a.pmSubmitMessage),e.emit("privatemsg",{nick:a.nickSelected,message:a.pmSubmitMessage},function(b){b?(void 0===a.pmMessages[a.nickSelected]&&(a.pmMessages[a.nickSelected]=[]),a.pmMessages[a.nickSelected].push({sender:a.nickId,message:a.pmSubmitMessage,timestamp:j()}),a.pmSubmitMessage=""):(void 0===a.pmMessages[a.nickSelected]&&(a.pmMessages[a.nickSelected]=[]),a.pmMessages[a.nickSelected].push({sender:"server",message:"Failed to send message"}))}))},e.on("recv_privatemsg",function(b,c){void 0===a.pmMessages[b]&&(a.pmMessages[b]=[]),a.pmMessages[b].push({sender:b,message:c,timestamp:j()}),a.nickSelected!==b&&(a.pmUnreadFrom[b]=!0),a.userSelected===!1&&a.showPmBox(b)}),a.partRoom=function(){e.emit("partroom",a.roomId),d.path("/rooms/"+a.nickId)},e.on("updatechat",function(b,c){if(b===a.roomId){a.messages=[];for(var d=0;d<c.length;d++){var e=new Date(c[d].timestamp);a.messages.push({nick:c[d].nick,message:c[d].message,timestamp:i(e)}),console.log(JSON.stringify(a.messages[d]))}}}),e.on("updatetopic",function(b,c){b===a.roomId&&(a.topic=c)}),a.showPmBox=function(b){a.nickId!==b&&(a.nickSelected!=b?(a.nickSelected=b,a.userSelected=!0,a.pmUnreadFrom[b]=!1):(a.userSelected=!1,a.nickSelected="",a.pmUnreadFrom[b]=!1))},a.opUser=function(b){void 0!==b&&e.emit("op",{room:a.roomId,user:b},function(a){a||alertify.error("Could not op "+b)})},a.deopUser=function(b){void 0!==b&&e.emit("deop",{room:a.roomId,user:b},function(a){a||alertify.error("Could not deop "+b)})},a.kickUser=function(b){void 0!==b&&e.emit("kick",{room:a.roomId,user:b},function(a){a||alertify.error("Could not kick "+b)})},a.banUser=function(b){void 0!==b&&e.emit("ban",{room:a.roomId,user:b},function(a){a||alertify.error("Could not ban "+b)})},e.on("kicked",function(b,c,e){a.roomId===b&&a.nickId===c&&(d.path("/rooms/"+a.nickId),alertify.error("You have been kicked from "+b))}),e.on("banned",function(b,c,e){a.roomId===b&&a.nickId===c&&(d.path("/rooms/"+a.nickId),alertify.error("You have been banned from "+b,0))}),e.on("opped",function(b,c,d){a.roomId===b&&a.nickId===c&&alertify.success("You are now op")}),e.on("deopped",function(b,c,d){a.roomId===b&&a.nickId===c&&alertify.error("You have been deopped")}),a.changeTopic=function(){alertify.prompt("Topic: ",function(b,c){b===!0&&((void 0===c||""===c)&&alertify.error("Topic can not be empty"),e.emit("settopic",{room:a.roomId,topic:c},function(a){a?alertify.success("Topic has been changed"):alertify.error("Could not change topic")}))})},a.changePassword=function(){alertify.prompt("Password: ",function(b,c){if(b===!0){if(void 0===c||""===c)return void alertify.error("Can not change password to empty, use the remove password instead");e.emit("setpassword",{room:a.roomId,password:c},function(a){a?alertify.success("Password has been changed"):alertify.error("Could not change password")})}})},a.removePassword=function(){e.emit("removepassword",{room:a.roomId},function(a){a?alertify.success("Password removed"):alertify.success("Could not remove the password")})},a.unbanUser=function(){alertify.prompt("User: ",function(b,c){if(b===!0){if(void 0===c||""===c)return void alertify.error("Can not unban empty");e.emit("unban",{room:a.roomId,user:c},function(a){a||alertify.error("Could not unban user")})}})}}]),angular.module("ChatApp").controller("RoomsCtrl",["$scope","$http","$routeParams","$location","socket","$rootScope",function(a,b,c,d,e,f){a.nickId=c.nickId,a.roomId="",a.rooms=[],a.errorMessage="",a.create_error=!1,a.$on("$destroy",function(a){e.getSocket().removeAllListeners()}),a.newRoom=function(){""===a.roomId?(a.errorMessage="Please enter room name",a.create_error=!0):void 0!==a.rooms[a.roomId]?(a.errorMessage="The room name "+a.roomId+" is already taken",a.create_error=!0):e.emit("createroom",{room:a.roomId},function(b,c){b&&d.path("/rooms/"+a.nickId+"/"+a.roomId).search({locked:!1})})},e.on("servermessage",function(b,c,d,e){switch(b){case"unban":e===a.nickId&&alertify.success("You have been unbanned from "+c+" by "+d)}}),e.on("roomlist",function(b){a.rooms=b,a.roomlist=[],$.each(a.rooms,function(b,c){a.roomlist.push({name:b,locked:c.locked,size:Object.keys(c.users).length})})}),e.emit("rooms")}]),angular.module("ChatApp",["ng","ngRoute","luegg.directives"]),angular.module("ChatApp").config(function(a){a.when("/home/login",{templateUrl:"/views/home.html",controller:"HomeCtrl"}).when("/rooms/:nickId",{templateUrl:"/views/rooms.html",controller:"RoomsCtrl"}).when("/rooms/:nickId/:roomId",{templateUrl:"/views/room.html",controller:"RoomCtrl"}).otherwise({redirectTo:"home/login"})}),angular.module("ChatApp").factory("socket",["$rootScope",function(a){var b=io.connect("http://localhost:8080");return{on:function(c,d){b.on(c,function(){var c=arguments;a.$apply(function(){d.apply(b,c)})})},emit:function(c,d,e){b.emit(c,d,function(){var c=arguments;a.$apply(function(){e&&e.apply(b,c)})})},getSocket:function(){return b}}}]);